---
title: "Getting Started with gamlssTools"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Getting Started with gamlssTools}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE,
  markup = FALSE,
  fig.width = 8, 
  fig.height = 7
)
```

```{r setup}
library(gamlssTools)
```

This vignette will use two datasets: the iris dataset from the dplyr package and a toy dataset simulated below.

```{r}
df <- data.frame(
  Age = sample(0:36525, 10000, replace = TRUE),
  Sex = sample(c("Male", "Female"), 10000, replace = TRUE),
  Study = factor(sample(c("Study_A", "Study_B", "Study_C"), 10000, replace = TRUE))
)

# Encode sex as numeric for interaction
sex_num <- ifelse(df$Sex == "Male", 0, 1)

# Study effects
study_effects <- c(Study_A = -3, Study_B = 0, Study_C = 1)

# Simulate Pheno with:
# - nonlinear effect of age
# - main effect of sex
# - age × sex interaction
# - site-specific offsets
# - noise
df$Pheno <- ((df$Age/ 365)^3) * (1 + 0.5 * sex_num) +      # age effect + interaction with sex
             2 * sex_num +                                  # main effect of sex
             study_effects[df$Study] * 50000 +                  # study/site effect
             rnorm(nrow(df), mean = 0, sd = 100000)         # noise

# Rescale to 1–10
df$Pheno <- scales::rescale(df$Pheno, to = c(1, 10))
```

## Centile Fan Plots

The basic use-case for gamlssTools is plotting gamlss models. Note that while we use a model fit with the original [gamlss](https://cran.r-project.org/web/packages/gamlss/index.html) package, the functions in gamlssTools are also compatible with the newer [gamlss2](https://github.com/gamlss-dev/gamlss2).

We'll start by fitting a simple model on the iris dataset:

```{r}
#fit gamlss model
iris_model <- gamlss(formula = Sepal.Width ~ pb(Sepal.Length) + Species, sigma.formula = ~ Sepal.Length, data=iris, family=BCCG)

#basic plot
iris_fan_plot <- make_centile_fan(iris_model, iris, "Sepal.Length", "Species")
print(iris_fan_plot)
```

You can use all the standard ggplot layers to make your plot prettier.

```{r}
iris_fan_plot +
  labs(title="Normative Sepal Width by Length",
  x ="Sepal Length", y = "Sepal Width",
  color = "Species", fill="Species") +
  theme_bw() +
  scale_colour_viridis_d()
```

Note that these centile fan plots are conditional upon any other covariates in your model (i.e., any covariates beyond those shown in the x-axis or via color are held at their respective means/modes). This is very useful for visualizing a trend across age, say, without being bogged down by nuisance effects, like batch or site effects This does sometimes lead to a mismatch with the individual data points and centile lines, however, as the points still reflect differences across site that are controlled for in the centile lines. 

```{r}
pheno_model <- gamlss(formula = Pheno ~ pb(Age) + Sex + random(Study), sigma.formula= ~ pb(Age) + Sex, data = df, family=BCCG)
make_centile_fan(pheno_model, df, "Age", "Sex")
```

You can residualize out the estimated effect of a nuisance covariate (like study or site) from your data points to more cleanly display your data.

```{r}
make_centile_fan(pheno_model, df, "Age", "Sex", remove_point_effect = "Study", x_axis="lifespan")
```

There are many other options you can use to customize/adjust your plots - see the documentation for `make_centile_fan()`.
There are also a number of wrapper functions that apply different defaults to/otherwise streamline centile plotting. These include:

- `centile_fan_lifespan()`: Plot centiles in the style of Bethlehem, Seidletz & White et al, Nature 2020.
- `plot_centile_deriv()`: Plot derivative of median centile
- `plot_centile_cis()`: Plot median with 95% confidence intervals (see Bootstrapping & Confidence Intervals vignette for more)


## Model Diagnostics

There are several quantitative and qualitative checks you'll likely want to perform on your models.

First, we can return BIC and AIC built-into the gamlss model object (note: will be different when using gamlss2 objects)
```{r}
pheno_model$aic #AIC
pheno_model$sbc #BIC
```

Another helpful check is the worm plot. `wp.taki()` enhances the built-in `gamlss::wp()` by allowing you to break up plots along chunks of a continuous variable (like age) or by levels of a categorical variable (like sex), so you can make sure the model fits all groups well.

```{r}
#plot by age
wp.taki(xvar=df$Age, resid=resid(pheno_model))

#plot by sex
df$Sex <- as.factor(df$Sex)
wp.taki(xvar=df$Sex, resid=resid(pheno_model))
```

You can also check how well the predicted centiles for each point/subject line up with the percentiles themselves - that is, about 5% of subjects' centiles should be <= 0.05.

```{r}
cent_cdf(pheno_model, df)

#we can also view this by sex or age
cent_cdf(pheno_model, df, group="Sex")
cent_cdf(pheno_model, df, interval_var = "Age", n=4)
```

## Calculating Centiles

Now let's say you want to get the centile values for each subject in your dataset or a new dataset.

We'll start by simulating a small, new dataset.
```{r}
test_df <- data.frame(
  Age = sample(0:36525, 100, replace = TRUE),
  Sex = sample(c("Male", "Female"), 100, replace = TRUE),
  Study = factor(sample(c("Study_A", "Study_B", "Study_C"), 100, replace = TRUE))
)
# Encode sex as numeric for interaction
sex_num <- ifelse(test_df$Sex == "Male", 0, 1)

test_df$Pheno <- ((test_df$Age / 365)^3) * (1 + 0.5 * sex_num) +      # age effect + interaction with sex
             2 * sex_num +                                  # main effect of sex
             study_effects[test_df$Study] * 50000 +                  # study/site effect
             rnorm(nrow(test_df), mean = 0, sd = 100000)         # noise

# Rescale to 1–10
test_df$Pheno <- scales::rescale(test_df$Pheno, to = c(1, 10))
```

Now we can return the centile values for each subject, as estimated by our model above.

```{r}
test_df$centiles <- pred_og_centile(pheno_model, og.data=df, new.data=test_df)
range(test_df$centiles)
```